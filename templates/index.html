<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Score Rankings</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px}
    h2{margin-top:28px}
    .tabs{display:flex;gap:6px;margin-bottom:8px}
    .tab-btn{background:#eee;border:1px solid #ddd;padding:6px 10px;cursor:pointer}
    .tab-btn.active{background:#fff;border-bottom:2px solid #0078d4}
    .tab-panel{display:none}
    .tab-panel.active{display:block}
  </style>
</head>
<body>
  <h1>Score Rankings</h1>
  <div style="margin-bottom:12px">
    <button id="refreshBtn">更新</button>
    <span id="status" style="margin-left:8px;color:#666"></span>
    <span id="countdown" style="margin-left:12px;color:#444"></span>
  </div>

  <div id="rankings">
  <div class="tabs">
    {% for title, items in rankings.items() %}
      <button class="tab-btn{% if loop.first %} active{% endif %}" data-target="tab-{{ loop.index0 }}">{{ title }}</button>
    {% endfor %}
  </div>

  <div class="tab-contents">
    {% for title, items in rankings.items() %}
      <div id="tab-{{ loop.index0 }}" class="tab-panel{% if loop.first %} active{% endif %}" data-title="{{ title }}">
        <h2>{{ title }}</h2>
        <ol>
          {% for it in items %}
            <li>{{ it.player }}: {{ it.value }}</li>
          {% endfor %}
        </ol>
      </div>
    {% endfor %}
  </div>
  </div>

  <script>
    // Tab switching
    function activateTab(index){
      document.querySelectorAll('.tab-panel').forEach((p, i)=>{
        p.classList.toggle('active', String(i)===String(index));
      });
      document.querySelectorAll('.tab-btn').forEach((b, i)=>{
        b.classList.toggle('active', String(i)===String(index));
      });
    }
    document.querySelectorAll('.tab-btn').forEach((btn, i)=>{
      btn.addEventListener('click', ()=> activateTab(i));
    });
    const REFRESH_RATE = {{ refresh_rate | default(0) | tojson }};
    let remaining = REFRESH_RATE;

    function updateCountdownDisplay(){
      const el = document.getElementById('countdown');
      if(!el) return;
      if(!REFRESH_RATE || REFRESH_RATE <= 0){
        el.textContent = '';
        return;
      }
      el.textContent = `次の自動更新まで: ${remaining}s`;
    }
    async function renderRankings(obj){
      // Update each tab-panel content by matching panel's data-title to ranking title
      const panels = Array.from(document.querySelectorAll('.tab-panel'));
      for(const title in obj){
        const items = obj[title];
        const panel = panels.find(p => p.dataset.title === title);
        if(!panel) continue;
        const ol = panel.querySelector('ol');
        if(!ol) continue;
        ol.innerHTML = '';
        for(const it of items){
          const li = document.createElement('li');
          li.textContent = `${it.player}: ${it.value}`;
          ol.appendChild(li);
        }
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', async function(){
      const status = document.getElementById('status');
      status.textContent = '更新中...';
      try{
        const res = await fetch('/api/refresh');
        if(!res.ok) throw new Error('network');
        const j = await res.json();
        renderRankings(j.rankings);
        status.textContent = '更新完了';
        // reset countdown after manual refresh
        remaining = REFRESH_RATE;
        updateCountdownDisplay();
        setTimeout(()=>status.textContent='', 2000);
      }catch(e){
        status.textContent = '更新失敗';
        console.error(e);
      }
    });

    // Auto-refresh if enabled (>0 seconds)
    if (REFRESH_RATE && REFRESH_RATE > 0) {
      // initial display
      remaining = REFRESH_RATE;
      updateCountdownDisplay();

      // countdown timer: update every 1s
      setInterval(() => {
        if (remaining > 0) {
          remaining -= 1;
        }
        updateCountdownDisplay();
      }, 1000);

      // auto fetch interval
      setInterval(async () => {
        try {
          const res = await fetch('/api/refresh');
          if (!res.ok) throw new Error('network');
          const j = await res.json();
          renderRankings(j.rankings);
          // reset countdown after auto refresh
          remaining = REFRESH_RATE;
          updateCountdownDisplay();
        } catch (e) {
          console.error('Auto-refresh failed', e);
        }
      }, REFRESH_RATE * 1000);
    } else {
      // ensure countdown hidden when disabled
      remaining = 0;
      updateCountdownDisplay();
    }
  </script>
</body>
</html>
