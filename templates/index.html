<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Score Rankings</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px}
    h2{margin-top:28px}
  </style>
</head>
<body>
  <h1>Score Rankings</h1>
  <div style="margin-bottom:12px">
    <button id="refreshBtn">更新</button>
    <span id="status" style="margin-left:8px;color:#666"></span>
    <span id="countdown" style="margin-left:12px;color:#444"></span>
  </div>

  <div id="rankings">
  {% for title, items in rankings.items() %}
    <h2>{{ title }}</h2>
    <ol>
      {% for it in items %}
        <li>{{ it.player }}: {{ it.value }}</li>
      {% endfor %}
    </ol>
  {% endfor %}
  </div>

  <script>
    const REFRESH_RATE = {{ refresh_rate | default(0) | tojson }};
    let remaining = REFRESH_RATE;

    function updateCountdownDisplay(){
      const el = document.getElementById('countdown');
      if(!el) return;
      if(!REFRESH_RATE || REFRESH_RATE <= 0){
        el.textContent = '';
        return;
      }
      el.textContent = `次の自動更新まで: ${remaining}s`;
    }
    async function renderRankings(obj){
      const container = document.getElementById('rankings');
      container.innerHTML = '';
      for(const title in obj){
        const h = document.createElement('h2');
        h.textContent = title;
        container.appendChild(h);
        const ol = document.createElement('ol');
        for(const it of obj[title]){
          const li = document.createElement('li');
          li.textContent = `${it.player}: ${it.value}`;
          ol.appendChild(li);
        }
        container.appendChild(ol);
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', async function(){
      const status = document.getElementById('status');
      status.textContent = '更新中...';
      try{
        const res = await fetch('/api/refresh');
        if(!res.ok) throw new Error('network');
        const j = await res.json();
        renderRankings(j.rankings);
        status.textContent = '更新完了';
        // reset countdown after manual refresh
        remaining = REFRESH_RATE;
        updateCountdownDisplay();
        setTimeout(()=>status.textContent='', 2000);
      }catch(e){
        status.textContent = '更新失敗';
        console.error(e);
      }
    });

    // Auto-refresh if enabled (>0 seconds)
    if (REFRESH_RATE && REFRESH_RATE > 0) {
      // initial display
      remaining = REFRESH_RATE;
      updateCountdownDisplay();

      // countdown timer: update every 1s
      setInterval(() => {
        if (remaining > 0) {
          remaining -= 1;
        }
        updateCountdownDisplay();
      }, 1000);

      // auto fetch interval
      setInterval(async () => {
        try {
          const res = await fetch('/api/refresh');
          if (!res.ok) throw new Error('network');
          const j = await res.json();
          renderRankings(j.rankings);
          // reset countdown after auto refresh
          remaining = REFRESH_RATE;
          updateCountdownDisplay();
        } catch (e) {
          console.error('Auto-refresh failed', e);
        }
      }, REFRESH_RATE * 1000);
    } else {
      // ensure countdown hidden when disabled
      remaining = 0;
      updateCountdownDisplay();
    }
  </script>
</body>
</html>
