<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>{{ page_title }}</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent-2:#06b6d4;
      --shadow: 0 6px 18px rgba(15,23,42,0.08);
    }
    html,body{height:100%;margin:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#0f172a;padding:24px}
    .container{max-width:980px;margin:0 auto}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:18px}
    header .title{display:flex;flex-direction:column}
    h1{margin:0;font-size:20px;font-weight:700}
    /* subtitle removed per preference */
    .subtitle{display:none}

    .controls{display:flex;align-items:center;gap:10px}
    button{font-weight:600;border-radius:8px;border:0;padding:8px 12px;cursor:pointer}
    /* remove heavy shadow to avoid cheap look */
    #refreshBtn{background:linear-gradient(180deg,var(--accent),#1e40af);color:#fff;border:0}
    #refreshBtn:hover{filter:brightness(1.04)}
    #refreshBtn:active{transform:translateY(1px)}
    #status{color:var(--muted);font-size:13px}
    #countdown{color:var(--muted);font-size:13px}

    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);}

    .tabs{display:flex;gap:8px;margin:18px 0 20px;flex-wrap:wrap}
    .tab-btn{background:transparent;border:1px solid transparent;padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
    .tab-btn.active{background:linear-gradient(90deg, rgba(37,99,235,0.08), rgba(6,182,212,0.04));color:var(--accent);box-shadow:inset 0 -2px 0 rgba(37,99,235,0.08)}

    .tab-panel{display:none;padding-top:8px}
    .tab-panel.active{display:block}
    .tab-panel h2{margin-top:12px;font-size:16px}
    ol{padding-left:18px;margin:8px 0}
    li{padding:8px 12px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(15,23,42,0.02), rgba(15,23,42,0.01));display:flex;justify-content:space-between;align-items:center}
    .player{font-weight:600;color:#0f172a;margin-left:8px}
    .score{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-weight:800;color:var(--accent);font-size:1.05rem}
    .rank{color:var(--muted);font-weight:700;width:28px;display:inline-block;text-align:right;margin-right:8px}

    @media (max-width:600px){
      body{padding:14px}
      header{flex-direction:column;align-items:stretch}
      .controls{justify-content:flex-start}
    }
  </style>
  </head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <h1>{{ page_title }}</h1>
        <div class="subtitle">リアルタイムランキング（RCON経由）</div>
      </div>
      <div class="controls">
        <button id="refreshBtn">更新</button>
        <span id="status"></span>
        <span id="countdown"></span>
      </div>
    </header>

    <div class="card" id="rankings">
  <div class="tabs">
    {% for title, items in rankings.items() %}
      <button class="tab-btn{% if loop.first %} active{% endif %}" data-target="tab-{{ loop.index0 }}">{{ title }}</button>
    {% endfor %}
    </div>
  </div>

  <div class="tab-contents">
    {% for title, items in rankings.items() %}
      <div id="tab-{{ loop.index0 }}" class="tab-panel{% if loop.first %} active{% endif %}" data-title="{{ title }}">
        <h2>{{ title }}</h2>
        <ol>
          {% for it in items %}
            <li><span class="rank">{{ loop.index }}.</span><span class="player">{{ it.player }}</span><span class="score">{{ it.value }}</span></li>
          {% endfor %}
        </ol>
      </div>
    {% endfor %}
  </div>
  </div>

  <script>
    // Tab switching
    function activateTab(index){
      document.querySelectorAll('.tab-panel').forEach((p, i)=>{
        p.classList.toggle('active', String(i)===String(index));
      });
      document.querySelectorAll('.tab-btn').forEach((b, i)=>{
        b.classList.toggle('active', String(i)===String(index));
      });
    }
    document.querySelectorAll('.tab-btn').forEach((btn, i)=>{
      btn.addEventListener('click', ()=> activateTab(i));
    });
    const REFRESH_RATE = {{ refresh_rate | default(0) | tojson }};
    let remaining = REFRESH_RATE;

    function updateCountdownDisplay(){
      const el = document.getElementById('countdown');
      if(!el) return;
      if(!REFRESH_RATE || REFRESH_RATE <= 0){
        el.textContent = '';
        return;
      }
      el.textContent = `次の自動更新まで: ${remaining}s`;
    }
    async function renderRankings(obj){
      // Update each tab-panel content by matching panel's data-title to ranking title
      const panels = Array.from(document.querySelectorAll('.tab-panel'));
      for(const title in obj){
        const items = obj[title];
        const panel = panels.find(p => p.dataset.title === title);
        if(!panel) continue;
        const ol = panel.querySelector('ol');
        if(!ol) continue;
        ol.innerHTML = '';
        items.forEach((it, idx) => {
          const li = document.createElement('li');
          const r = document.createElement('span');
          r.className = 'rank';
          r.textContent = (idx + 1) + '.';
          const p = document.createElement('span');
          p.className = 'player';
          p.textContent = it.player;
          const s = document.createElement('span');
          s.className = 'score';
          s.textContent = it.value;
          li.appendChild(r);
          li.appendChild(p);
          li.appendChild(s);
          ol.appendChild(li);
        });
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', async function(){
      const status = document.getElementById('status');
      status.textContent = '更新中...';
      try{
        const res = await fetch('/api/refresh');
        if(!res.ok) throw new Error('network');
        const j = await res.json();
        renderRankings(j.rankings);
        status.textContent = '更新完了';
        // reset countdown after manual refresh
        remaining = REFRESH_RATE;
        updateCountdownDisplay();
        setTimeout(()=>status.textContent='', 2000);
      }catch(e){
        status.textContent = '更新失敗';
        console.error(e);
      }
    });

    // Auto-refresh if enabled (>0 seconds)
    if (REFRESH_RATE && REFRESH_RATE > 0) {
      // initial display
      remaining = REFRESH_RATE;
      updateCountdownDisplay();

      // countdown timer: update every 1s
      setInterval(() => {
        if (remaining > 0) {
          remaining -= 1;
        }
        updateCountdownDisplay();
      }, 1000);

      // auto fetch interval
      setInterval(async () => {
        try {
          const res = await fetch('/api/refresh');
          if (!res.ok) throw new Error('network');
          const j = await res.json();
          renderRankings(j.rankings);
          // reset countdown after auto refresh
          remaining = REFRESH_RATE;
          updateCountdownDisplay();
        } catch (e) {
          console.error('Auto-refresh failed', e);
        }
      }, REFRESH_RATE * 1000);
    } else {
      // ensure countdown hidden when disabled
      remaining = 0;
      updateCountdownDisplay();
    }
  </script>
</body>
</html>
